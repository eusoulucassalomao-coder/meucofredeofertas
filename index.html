<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cofre de Ofertas v18 (Wizard + Controles Corrigidos)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --shopee-red: #ff2d2d; --bg-color: #f0f0f0; --success-green: #2e7d32; --panel-border: #e0e0e0; --step-active: #007bff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* --- STEP WIZARD CONTAINER --- */
        .main-container { width: 100%; max-width: 1100px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); margin-bottom: 30px; box-sizing: border-box; }
        
        /* Step Indicators */
        .step-indicator-container { display: flex; justify-content: space-between; margin-bottom: 30px; position: relative; }
        .step-indicator-container::before { content: ''; position: absolute; top: 15px; left: 0; width: 100%; height: 3px; background: #eee; z-index: 0; }
        .step-indicator { position: relative; z-index: 1; background: #eee; color: #999; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: 0.3s; }
        .step-indicator.active { background: var(--shopee-red); color: white; box-shadow: 0 0 0 4px rgba(255, 45, 45, 0.2); }
        .step-indicator.completed { background: var(--success-green); color: white; }

        /* Step Content */
        .step-content { display: none; animation: fadeIn 0.4s ease-in-out; }
        .step-content.active-step { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 { color: #333; margin-top: 0; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 25px; }
        .form-group { margin-bottom: 20px; }
        label { font-weight: bold; font-size: 0.9rem; color: #555; display: block; margin-bottom: 8px; }
        input[type="text"], textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; transition: 0.3s; }
        input:focus, textarea:focus { border-color: var(--shopee-red); outline: none; }

        /* Upload Box Stylish */
        .upload-container-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .styled-upload-box { border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 12px; cursor: pointer; background: #fafafa; transition: 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 120px; }
        .styled-upload-box:hover { background: #f0f0f0; border-color: var(--shopee-red); }
        .styled-upload-box i { font-size: 2rem; color: #999; margin-bottom: 10px; }
        .file-status { font-size: 0.8rem; color: var(--success-green); margin-top: 5px; font-weight: bold; display: none; }

        /* Navigation Buttons */
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 40px; border-top: 1px solid #eee; padding-top: 20px; }
        .btn-nav { padding: 12px 25px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .btn-prev { background: #e0e0e0; color: #555; }
        .btn-prev:hover { background: #d0d0d0; }
        .btn-next { background: var(--shopee-red); color: white; margin-left: auto; }
        .btn-next:hover { background: #e60000; }
        .btn-disabled { opacity: 0.5; cursor: not-allowed; }

        /* --- ETAPA 2: LINK EXTRACTION --- */
        .link-extraction-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-extract { background: #333; color: white; border: none; border-radius: 8px; padding: 0 20px; font-weight: bold; cursor: pointer; white-space: nowrap; }
        .btn-extract:hover { background: #555; }
        .link-helper { font-size: 0.8rem; color: #888; margin-top: 5px; background: #fff3cd; padding: 10px; border-radius: 5px; border-left: 4px solid #ffc107; }

        /* --- ETAPA 4: PREVIEWS (Layout v17 adaptado) --- */
        .final-step-container { display: flex; flex-wrap: wrap; gap: 30px; justify-content: center; }
        .preview-wrapper { display: flex; gap: 15px; align-items: flex-start; }
        @media (max-width: 800px) { .preview-wrapper { flex-wrap: wrap; justify-content: center; } }
        .canvas-column { display: flex; flex-direction: column; align-items: center; }
        
        /* --- CONTROL PANEL STYLES (v17) --- */
        .control-panel { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; flex-direction: column; min-width: 165px; overflow: hidden; border: 1px solid var(--panel-border); }
        .panel-header { background: #f9f9f9; padding: 10px; text-align: center; font-weight: 800; color: #555; font-size: 0.85rem; border-bottom: 1px solid var(--panel-border); text-transform: uppercase; }
        .unified-group { padding: 12px 10px; border-bottom: 1px solid #eee; display: flex; flex-direction: column; gap: 6px; }
        .unified-group:last-child { border-bottom: none; }
        .control-label { font-size: 0.7rem; font-weight: 800; color: #333; margin-bottom: 2px; display: block; text-transform: uppercase;}
        .special-label { color: var(--shopee-red); }
        .size-actions, .move-actions { display: flex; align-items: center; justify-content: space-between; background: #f0f0f0; border-radius: 6px; padding: 3px;}
        .move-actions { justify-content: center; gap: 3px; }
        .btn-size, .btn-move { width: 26px; height: 26px; border: 1px solid #ddd; background: white; color: #333; font-weight: bold; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-size:hover, .btn-move:hover { background: #eee; }
        .size-display { font-size: 0.8rem; font-weight: bold; color: #555; }
        
        /* --- CANVAS STYLES (v17) --- */
        .design-canvas { background-color: #ddd; background-size: 100% 100%; background-repeat: no-repeat; position: relative; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .content-area { position: absolute; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; box-sizing: border-box; }
        .image-wrapper { width: 100%; display: flex; align-items: center; justify-content: center; margin-bottom: 5px; overflow: hidden; }
        .img-display { max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; transition: transform 0.2s ease; }
        .text-desc { text-align: center; font-weight: 700; color: #333; text-transform: uppercase; line-height: 1.3; display: flex; align-items: center; justify-content: center; padding: 0 20px; box-sizing: border-box; width: 100%; }
        .price-container { display: flex; flex-direction: column; align-items: center; margin-top: auto; }
        .price-old { color: var(--shopee-red); text-decoration: line-through; font-weight: bold; margin-bottom: 2px; }
        .promo-button { background: var(--shopee-red); color: white; display: inline-flex; align-items: center; justify-content: center; border-radius: 10px; font-weight: 900; text-transform: uppercase; box-shadow: 0 2px 5px rgba(0,0,0,0.2); white-space: nowrap; padding: 0.4em 1em; }
        
        /* FEED SPECIFIC */
        #feed-design { width: 360px; height: 450px; --f-desc-size: 12px; --f-old-size: 13px; --f-btn-size: 18px; --f-img-scale: 1; --f-img-top: 0px; --f-img-left: 0px; --f-desc-top: 0px; --f-desc-left: 0px; --f-old-top: 0px; --f-old-left: 0px; --f-btn-top: 0px; --f-btn-left: 0px; }
        #feed-design .content-area { top: 125px; width: 290px; height: 290px; }
        #feed-design .image-wrapper { height: 170px; top: var(--f-img-top); left: var(--f-img-left); }
        #feed-design .img-display { transform: scale(var(--f-img-scale)); }
        #feed-design .text-desc { font-size: var(--f-desc-size); height: 45px; top: var(--f-desc-top); left: var(--f-desc-left); }
        #feed-design .price-container { padding-bottom: 10px; }
        #feed-design .price-old { font-size: var(--f-old-size); top: var(--f-old-top); left: var(--f-old-left); }
        #feed-design .promo-button { font-size: var(--f-btn-size); top: var(--f-btn-top); left: var(--f-btn-left); }

        /* STORY SPECIFIC */
        #story-design { width: 324px; height: 576px; --s-desc-size: 14px; --s-old-size: 15px; --s-btn-size: 20px; --s-img-scale: 1; --s-img-top: 0px; --s-img-left: 0px; --s-desc-top: -20px; --s-desc-left: 0px; --s-old-top: 0px; --s-old-left: 0px; --s-btn-top: 0px; --s-btn-left: 0px; }
        #story-design .content-area { top: 155px; width: 280px; height: 360px; }
        #story-design .image-wrapper { height: 185px; margin-bottom: 10px; top: var(--s-img-top); left: var(--s-img-left); }
        #story-design .img-display { transform: scale(var(--s-img-scale)); }
        #story-design .text-desc { font-size: var(--s-desc-size); height: 60px; margin-bottom: 5px; top: var(--s-desc-top); left: var(--s-desc-left); }
        #story-design .price-container { padding-bottom: 5px; }
        #story-design .price-old { font-size: var(--s-old-size); top: var(--s-old-top); left: var(--s-old-left); }
        #story-design .promo-button { font-size: var(--s-btn-size); top: var(--s-btn-top); left: var(--s-btn-left); }
        
        .download-btn { width: 100%; padding: 12px; background: #27ae60; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        .download-btn:hover { background: #219653; }
        .btn-story { background: #8e44ad; }
        .btn-story:hover { background: #732d91; }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="step-indicator-container">
            <div class="step-indicator active" id="indicator1">1</div>
            <div class="step-indicator" id="indicator2">2</div>
            <div class="step-indicator" id="indicator3">3</div>
            <div class="step-indicator" id="indicator4">4</div>
        </div>

        <div class="step-content active-step" data-step="1">
            <h2>Etapa 1: Imagens do Produto e Fundos</h2>
            <div class="upload-container-grid">
                <div class="styled-upload-box" onclick="document.getElementById('file-feed').click()">
                    <i>üñºÔ∏è</i>
                    <label style="cursor: pointer;">Fundo do Feed (4:5)</label>
                    <input id="file-feed" type="file" hidden accept="image/*" onchange="handleFileSelect(event, 'feed', 'status-feed')">
                    <span id="status-feed" class="file-status">Imagem selecionada!</span>
                </div>
                <div class="styled-upload-box" onclick="document.getElementById('file-story').click()">
                    <i>üì±</i>
                    <label style="cursor: pointer;">Fundo do Story (9:16)</label>
                    <input id="file-story" type="file" hidden accept="image/*" onchange="handleFileSelect(event, 'story', 'status-story')">
                    <span id="status-story" class="file-status">Imagem selecionada!</span>
                </div>
                 <div class="styled-upload-box" onclick="document.getElementById('inputImg').click()" style="border-color: var(--shopee-red); background: #fff5f5;">
                    <i style="color: var(--shopee-red);">üì∏</i>
                    <label style="cursor: pointer; color: var(--shopee-red);">Imagem do Produto (PNG)</label>
                    <input type="file" id="inputImg" hidden accept="image/*" onchange="handleProductImg(event)">
                    <span id="status-prod" class="file-status" style="color: var(--shopee-red);">Imagem selecionada!</span>
                </div>
            </div>
        </div>

        <div class="step-content" data-step="2">
            <h2>Etapa 2: T√≠tulo do Produto</h2>
            <div class="form-group">
                <label for="step2Link">Link do Produto (Shopee, Magalu, ML, Amazon)</label>
                <div class="link-extraction-group">
                    <input type="text" id="step2Link" placeholder="Cole o link aqui (Ex: https://www.magazinevoce.com.br/...)">
                    <button class="btn-extract" onclick="attemptTitleExtraction()">Tentar Extrair</button>
                </div>
                <p class="link-helper">‚ö†Ô∏è Links curtos (amzn.to, s.shopee, mercadolivre.com/sec) N√ÉO cont√™m o nome do produto. Para estes, digite o t√≠tulo manualmente abaixo.</p>
            </div>
            <div class="form-group">
                <label for="step2Title">T√≠tulo/Descri√ß√£o do Produto (Verifique ou Digite)</label>
                <textarea id="step2Title" rows="4" placeholder="O t√≠tulo aparecer√° aqui ou digite manualmente..."></textarea>
            </div>
        </div>

        <div class="step-content" data-step="3">
            <h2>Etapa 3: Valores da Oferta</h2>
            <div style="display: flex; gap: 20px;">
                <div class="form-group" style="flex: 1;">
                    <label for="step3OldPrice">Pre√ßo Antigo (De:)</label>
                    <input type="text" id="step3OldPrice" placeholder="R$ 0,00" oninput="formatCurrencyInput(this)">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="step3PromoPrice" style="color: var(--shopee-red);">Pre√ßo Promocional (Por:)</label>
                    <input type="text" id="step3PromoPrice" placeholder="R$ 0,00" style="border-color: var(--shopee-red); font-weight: bold;" oninput="formatCurrencyInput(this)">
                </div>
            </div>
        </div>

        <div class="step-content" data-step="4">
            <h2>Etapa 4: Ajustes Finais e Download</h2>
            
            <div class="final-step-container">
                 <div class="preview-wrapper">
                    <div class="canvas-column">
                        <div style="font-weight: bold; margin-bottom: 10px; text-align: center;">Feed</div>
                        <div id="feed-design" class="design-canvas">
                            <div class="content-area">
                                <div class="image-wrapper movable"><img id="viewImgFeed" class="img-display" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></div>
                                <div id="viewDescFeed" class="text-desc movable">AGUARDANDO...</div>
                                <div class="price-container">
                                    <div id="viewOldFeed" class="price-old movable">R$ 0,00</div>
                                    <div id="viewPromoFeed" class="promo-button movable">VALOR</div>
                                </div>
                            </div>
                        </div>
                        <button class="download-btn" onclick="download('feed-design', 'post-feed')">BAIXAR FEED</button>
                    </div>
                    <div class="control-panel">
                        <div class="panel-header">Ajustes Feed</div>
                         <div class="unified-group"><span class="control-label">Imagem (Posi√ß√£o/Zoom)</span><div class="move-actions"><button class="btn-move" onclick="adjustPos('feed-design', '--f-img-top', '--f-img-left', 'top', -2)">‚¨ÜÔ∏è</button><button class="btn-move" onclick="adjustPos('feed-design', '--f-img-top', '--f-img-left', 'top', 2)">‚¨áÔ∏è</button><button class="btn-move" onclick="adjustPos('feed-design', '--f-img-top', '--f-img-left', 'left', -2)">‚¨ÖÔ∏è</button><button class="btn-move" onclick="adjustPos('feed-design', '--f-img-top', '--f-img-left', 'left', 2)">‚û°Ô∏è</button></div><div class="size-actions" style="margin-top:5px"><button class="btn-size" onclick="adjustScale('feed-design', '--f-img-scale', -0.1)">-</button><span id="disp-f-img-scale" class="size-display">100%</span><button class="btn-size" onclick="adjustScale('feed-design', '--f-img-scale', 0.1)">+</button></div></div>
                        <div class="unified-group"><span class="control-label">Descri√ß√£o (Fonte/Pos)</span><div class="size-actions"><button class="btn-size" onclick="adjustValue('feed-design', '--f-desc-size', -1)">-</button><span id="disp-f-desc-size" class="size-display">12</span><button class="btn-size" onclick="adjustValue('feed-design', '--f-desc-size', 1)">+</button></div><div class="move-actions"><button class="btn-move" onclick="adjustPos('feed-design', '--f-desc-top', '--f-desc-left', 'top', -2)">‚¨ÜÔ∏è</button><button class="btn-move" onclick="adjustPos('feed-design', '--f-desc-top', '--f-desc-left', 'top', 2)">‚¨áÔ∏è</button><button class="btn-move" onclick="adjustPos('feed-design', '--f-desc-top', '--f-desc-left', 'left', -2)">‚¨ÖÔ∏è</button><button class="btn-move" onclick="adjustPos('feed-design', '--f-desc-top', '--f-desc-left', 'left', 2)">‚û°Ô∏è</button></div></div>
                        <div class="unified-group"><span class="control-label special-label">Bot√£o (Box/Pos)</span><div class="size-actions"><button class="btn-size" onclick="adjustValue('feed-design', '--f-btn-size', -1)">-</button><span id="disp-f-btn-size" class="size-display">18</span><button class="btn-size" onclick="adjustValue('feed-design', '--f-btn-size', 1)">+</button></div><div class="move-actions"><button class="btn-move" onclick="adjustPos('feed-design', '--f-btn-top', '--f-btn-left', 'top', -2)">‚¨ÜÔ∏è</button><button class="btn-move" onclick="adjustPos('feed-design', '--f-btn-top', '--f-btn-left', 'top', 2)">‚¨áÔ∏è</button><button class="btn-move" onclick="adjustPos('feed-design', '--f-btn-top', '--f-btn-left', 'left', -2)">‚¨ÖÔ∏è</button><button class="btn-move" onclick="adjustPos('feed-design', '--f-btn-top', '--f-btn-left', 'left', 2)">‚û°Ô∏è</button></div></div>
                    </div>
                </div>

                <div class="preview-wrapper">
                    <div class="canvas-column">
                        <div style="font-weight: bold; margin-bottom: 10px; text-align: center;">Story</div>
                        <div id="story-design" class="design-canvas">
                            <div class="content-area">
                                <div class="image-wrapper movable"><img id="viewImgStory" class="img-display" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></div>
                                <div id="viewDescStory" class="text-desc movable">AGUARDANDO...</div>
                                <div class="price-container">
                                    <div id="viewOldStory" class="price-old movable">R$ 0,00</div>
                                    <div id="viewPromoStory" class="promo-button movable">VALOR</div>
                                </div>
                            </div>
                        </div>
                        <button class="download-btn btn-story" onclick="download('story-design', 'post-story')">BAIXAR STORY</button>
                    </div>
                    <div class="control-panel" style="border-color: #8e44ad;">
                        <div class="panel-header" style="background: #f4eafc; color: #8e44ad;">Ajustes Story</div>
                        <div class="unified-group"><span class="control-label">Imagem (Posi√ß√£o/Zoom)</span><div class="move-actions"><button class="btn-move" onclick="adjustPos('story-design', '--s-img-top', '--s-img-left', 'top', -2)">‚¨ÜÔ∏è</button><button class="btn-move" onclick="adjustPos('story-design', '--s-img-top', '--s-img-left', 'top', 2)">‚¨áÔ∏è</button><button class="btn-move" onclick="adjustPos('story-design', '--s-img-top', '--s-img-left', 'left', -2)">‚¨ÖÔ∏è</button><button class="btn-move" onclick="adjustPos('story-design', '--s-img-top', '--s-img-left', 'left', 2)">‚û°Ô∏è</button></div><div class="size-actions" style="margin-top:5px"><button class="btn-size" onclick="adjustScale('story-design', '--s-img-scale', -0.1)">-</button><span id="disp-s-img-scale" class="size-display">100%</span><button class="btn-size" onclick="adjustScale('story-design', '--s-img-scale', 0.1)">+</button></div></div>
                        <div class="unified-group"><span class="control-label">Descri√ß√£o (Fonte/Pos)</span><div class="size-actions"><button class="btn-size" onclick="adjustValue('story-design', '--s-desc-size', -1)">-</button><span id="disp-s-desc-size" class="size-display">14</span><button class="btn-size" onclick="adjustValue('story-design', '--s-desc-size', 1)">+</button></div><div class="move-actions"><button class="btn-move" onclick="adjustPos('story-design', '--s-desc-top', '--s-desc-left', 'top', -2)">‚¨ÜÔ∏è</button><button class="btn-move" onclick="adjustPos('story-design', '--s-desc-top', '--s-desc-left', 'top', 2)">‚¨áÔ∏è</button><button class="btn-move" onclick="adjustPos('story-design', '--s-desc-top', '--s-desc-left', 'left', -2)">‚¨ÖÔ∏è</button><button class="btn-move" onclick="adjustPos('story-design', '--s-desc-top', '--s-desc-left', 'left', 2)">‚û°Ô∏è</button></div></div>
                        <div class="unified-group"><span class="control-label">Pre√ßo Antigo</span><div class="size-actions"><button class="btn-size" onclick="adjustValue('story-design', '--s-old-size', -1)">-</button><span id="disp-s-old-size" class="size-display">15</span><button class="btn-size" onclick="adjustValue('story-design', '--s-old-size', 1)">+</button></div><div class="move-actions"><button class="btn-move" onclick="adjustPos('story-design', '--s-old-top', '--s-old-left', 'top', -2)">‚¨ÜÔ∏è</button><button class="btn-move" onclick="adjustPos('story-design', '--s-old-top', '--s-old-left', 'top', 2)">‚¨áÔ∏è</button><button class="btn-move" onclick="adjustPos('story-design', '--s-old-top', '--s-old-left', 'left', -2)">‚¨ÖÔ∏è</button><button class="btn-move" onclick="adjustPos('story-design', '--s-old-top', '--s-old-left', 'left', 2)">‚û°Ô∏è</button></div></div>
                        <div class="unified-group"><span class="control-label special-label">Bot√£o (Box/Pos)</span><div class="size-actions"><button class="btn-size" onclick="adjustValue('story-design', '--s-btn-size', -1)">-</button><span id="disp-s-btn-size" class="size-display">20</span><button class="btn-size" onclick="adjustValue('story-design', '--s-btn-size', 1)">+</button></div><div class="move-actions"><button class="btn-move" onclick="adjustPos('story-design', '--s-btn-top', '--s-btn-left', 'top', -2)">‚¨ÜÔ∏è</button><button class="btn-move" onclick="adjustPos('story-design', '--s-btn-top', '--s-btn-left', 'top', 2)">‚¨áÔ∏è</button><button class="btn-move" onclick="adjustPos('story-design', '--s-btn-top', '--s-btn-left', 'left', -2)">‚¨ÖÔ∏è</button><button class="btn-move" onclick="adjustPos('story-design', '--s-btn-top', '--s-btn-left', 'left', 2)">‚û°Ô∏è</button></div></div>
                    </div>
                </div>
            </div>
        </div>

        <div class
