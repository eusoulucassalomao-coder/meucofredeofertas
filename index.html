<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cofre de Ofertas v24 (Integra√ß√£o n8n/API)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* --- ESTILOS GERAIS (Mantidos da v23) --- */
        :root { --shopee-red: #ff2d2d; --bg-color: #f0f0f0; --success-green: #2e7d32; --panel-border: #e0e0e0; --step-active: #007bff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .main-container { width: 100%; max-width: 1100px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); margin-bottom: 30px; box-sizing: border-box; }
        .step-indicator-container { display: flex; justify-content: space-between; margin-bottom: 30px; position: relative; }
        .step-indicator-container::before { content: ''; position: absolute; top: 15px; left: 0; width: 100%; height: 3px; background: #eee; z-index: 0; }
        .step-indicator { position: relative; z-index: 1; background: #eee; color: #999; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: 0.3s; }
        .step-indicator.active { background: var(--shopee-red); color: white; box-shadow: 0 0 0 4px rgba(255, 45, 45, 0.2); }
        .step-indicator.completed { background: var(--success-green); color: white; }
        .step-content { display: none; animation: fadeIn 0.4s ease-in-out; }
        .step-content.active-step { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        h2 { color: #333; margin-top: 0; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 25px; }
        .form-group { margin-bottom: 20px; }
        label { font-weight: bold; font-size: 0.9rem; color: #555; display: block; margin-bottom: 8px; }
        input[type="text"], textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; transition: 0.3s; }
        input:focus, textarea:focus { border-color: var(--shopee-red); outline: none; }
        .upload-container-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .styled-upload-box { border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 12px; cursor: pointer; background: #fafafa; transition: 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 140px; }
        .styled-upload-box:hover { background: #f0f0f0; border-color: var(--shopee-red); }
        .upload-icon { font-size: 2rem; color: #999; margin-bottom: 10px; }
        .upload-thumbnail { width: 90px; height: 90px; object-fit: cover; border-radius: 8px; margin-bottom: 10px; border: 2px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: none; }
        .file-status { font-size: 0.8rem; color: var(--success-green); margin-top: 5px; font-weight: bold; display: none; }
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 40px; border-top: 1px solid #eee; padding-top: 20px; }
        .btn-nav { padding: 12px 25px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .btn-prev { background: #e0e0e0; color: #555; }
        .btn-next { background: var(--shopee-red); color: white; margin-left: auto; }
        .btn-disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* --- ESTILOS DA √ÅREA DE API (ETAPA 2) --- */
        .link-extraction-group { display: flex; gap: 10px; margin-bottom: 5px; }
        .btn-extract-api { background: var(--shopee-red); color: white; border: none; border-radius: 8px; padding: 0 25px; font-weight: bold; cursor: pointer; white-space: nowrap; display: flex; align-items: center; gap: 8px;}
        .btn-extract-api:hover { background: #d60000; }
        .btn-extract-api:disabled { background: #ccc; cursor: not-allowed; }
        #api-status-message { font-size: 0.85rem; margin-top: 8px; font-weight: bold; min-height: 1.2em; }

        /* --- PREVIEWS E CONTROLES (Mantidos v23) --- */
        .final-step-container { display: flex; flex-wrap: wrap; gap: 30px; justify-content: center; }
        .preview-wrapper { display: flex; gap: 15px; align-items: flex-start; }
        @media (max-width: 800px) { .preview-wrapper { flex-wrap: wrap; justify-content: center; } }
        .canvas-column { display: flex; flex-direction: column; align-items: center; }
        .control-panel { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; flex-direction: column; min-width: 165px; overflow: hidden; border: 1px solid var(--panel-border); }
        .panel-header { background: #f9f9f9; padding: 10px; text-align: center; font-weight: 800; color: #555; font-size: 0.85rem; border-bottom: 1px solid var(--panel-border); text-transform: uppercase; }
        .unified-group { padding: 12px 10px; border-bottom: 1px solid #eee; display: flex; flex-direction: column; gap: 6px; }
        .unified-group:last-child { border-bottom: none; }
        .control-label { font-size: 0.7rem; font-weight: 800; color: #333; margin-bottom: 2px; display: block; text-transform: uppercase;}
        .special-label { color: var(--shopee-red); }
        .size-actions, .move-actions { display: flex; align-items: center; justify-content: space-between; background: #f0f0f0; border-radius: 6px; padding: 3px;}
        .move-actions { justify-content: center; gap: 3px; }
        .btn-size, .btn-move { width: 26px; height: 26px; border: 1px solid #ddd; background: white; color: #333; font-weight: bold; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-size:hover, .btn-move:hover { background: #eee; }
        .size-display { font-size: 0.8rem; font-weight: bold; color: #555; }
        .design-canvas { background-color: #ddd; background-size: 100% 100%; background-repeat: no-repeat; position: relative; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .content-area { position: absolute; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; box-sizing: border-box; }
        .image-wrapper { width: 100%; display: flex; align-items: center; justify-content: center; margin-bottom: 5px; overflow: hidden; }
        .img-display { max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; transition: transform 0.2s ease; }
        .text-desc { text-align: center; font-weight: 700; color: #333; text-transform: uppercase; line-height: 1.3; display: flex; align-items: center; justify-content: center; padding: 0 20px; box-sizing: border-box; width: 100%; }
        .price-container { display: flex; flex-direction: column; align-items: center; margin-top: auto; }
        .price-old { color: var(--shopee-red); text-decoration: line-through; font-weight: bold; margin-bottom: 2px; }
        .promo-button { background: var(--shopee-red); color: white; display: inline-flex; align-items: center; justify-content: center; border-radius: 10px; font-weight: 900; text-transform: uppercase; box-shadow: 0 2px 5px rgba(0,0,0,0.2); white-space: nowrap; padding: 0.4em 1em; }
        
        /* FEED & STORY VARS (Mantidos v23) */
        #feed-design { width: 360px; height: 450px; --f-desc-size: 12px; --f-old-size: 13px; --f-btn-size: 18px; --f-img-scale: 1; --f-img-top: 0px; --f-img-left: 0px; --f-desc-top: 0px; --f-desc-left: 0px; --f-old-top: 0px; --f-old-left: 0px; --f-btn-top: 0px; --f-btn-left: 0px; }
        #feed-design .content-area { top: 125px; width: 290px; height: 290px; }
        #feed-design .image-wrapper { height: 170px; top: var(--f-img-top); left: var(--f-img-left); }
        #feed-design .img-display { transform: scale(var(--f-img-scale)); }
        #feed-design .text-desc { font-size: var(--f-desc-size); height: 45px; top: var(--f-desc-top); left: var(--f-desc-left); }
        #feed-design .price-container { padding-bottom: 10px; }
        #feed-design .price-old { font-size: var(--f-old-size); top: var(--f-old-top); left: var(--f-old-left); }
        #feed-design .promo-button { font-size: var(--f-btn-size); top: var(--f-btn-top); left: var(--f-btn-left); }
        #story-design { width: 324px; height: 576px; --s-desc-size: 14px; --s-old-size: 15px; --s-btn-size: 20px; --s-img-scale: 1; --s-img-top: 0px; --s-img-left: 0px; --s-desc-top: -20px; --s-desc-left: 0px; --s-old-top: 0px; --s-old-left: 0px; --s-btn-top: 0px; --s-btn-left: 0px; }
        #story-design .content-area { top: 155px; width: 280px; height: 360px; }
        #story-design .image-wrapper { height: 185px; margin-bottom: 10px; top: var(--s-img-top); left: var(--s-img-left); }
        #story-design .img-display { transform: scale(var(--s-img-scale)); }
        #story-design .text-desc { font-size: var(--s-desc-size); height: 60px; margin-bottom: 5px; top: var(--s-desc-top); left: var(--s-desc-left); }
        #story-design .price-container { padding-bottom: 5px; }
        #story-design .price-old { font-size: var(--s-old-size); top: var(--s-old-top); left: var(--s-old-left); }
        #story-design .promo-button { font-size: var(--s-btn-size); top: var(--s-btn-top); left: var(--s-btn-left); }
        
        .download-btn { width: 100%; padding: 12px; background: #27ae60; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        .download-btn:hover { background: #219653; }
        .btn-story { background: #8e44ad; }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="step-indicator-container">
            <div class="step-indicator active" id="indicator1">1</div>
            <div class="step-indicator" id="indicator2">2</div>
            <div class="step-indicator" id="indicator3">3</div>
            <div class="step-indicator" id="indicator4">4</div>
        </div>

        <div class="step-content active-step" data-step="1">
            <h2>Etapa 1: Imagens do Produto e Fundos</h2>
            <div class="upload-container-grid">
                <div class="styled-upload-box" onclick="document.getElementById('file-feed').click()">
                    <img id="thumb-feed" class="upload-thumbnail" src="">
                    <i id="icon-feed" class="upload-icon">üñºÔ∏è</i>
                    <label style="cursor: pointer;">Fundo do Feed (4:5)</label>
                    <input id="file-feed" type="file" hidden accept="image/*" onchange="handleFileSelect(event, 'feed', 'status-feed')">
                    <span id="status-feed" class="file-status">Imagem selecionada!</span>
                </div>
                <div class="styled-upload-box" onclick="document.getElementById('file-story').click()">
                    <img id="thumb-story" class="upload-thumbnail" src="">
                    <i id="icon-story" class="upload-icon">üì±</i>
                    <label style="cursor: pointer;">Fundo do Story (9:16)</label>
                    <input id="file-story" type="file" hidden accept="image/*" onchange="handleFileSelect(event, 'story', 'status-story')">
                    <span id="status-story" class="file-status">Imagem selecionada!</span>
                </div>
                 <div class="styled-upload-box" onclick="document.getElementById('inputImg').click()" style="border-color: var(--shopee-red); background: #fff5f5;">
                    <img id="thumb-prod" class="upload-thumbnail" src="">
                    <i id="icon-prod" class="upload-icon" style="color: var(--shopee-red);">üì∏</i>
                    <label style="cursor: pointer; color: var(--shopee-red);">Imagem do Produto</label>
                    <input type="file" id="inputImg" hidden accept="image/*" onchange="handleProductImg(event)">
                    <span id="status-prod" class="file-status" style="color: var(--shopee-red);">Imagem selecionada!</span>
                </div>
            </div>
        </div>

        <div class="step-content" data-step="2">
            <h2>Etapa 2: Dados do Produto (Via API)</h2>
            <div class="form-group">
                <label for="step2Link">Link do Produto (Shopee, Magalu, ML, Amazon)</label>
                <div class="link-extraction-group">
                    <input type="text" id="step2Link" placeholder="Cole o link aqui...">
                    <button id="btn-api-call" class="btn-extract-api" onclick="fetchDataFromN8N()">
                        <span>üöÄ</span> Consultar API Oficial
                    </button>
                </div>
                <div id="api-status-message"></div>
            </div>
            <div class="form-group">
                <label for="step2Title">T√≠tulo/Descri√ß√£o (Preenchido pela API ou Manual)</label>
                <textarea id="step2Title" rows="4" placeholder="O t√≠tulo aparecer√° aqui..."></textarea>
            </div>
        </div>

        <div class="step-content" data-step="3">
            <h2>Etapa 3: Valores da Oferta</h2>
            <div style="display: flex; gap: 20px;">
                <div class="form-group" style="flex: 1;">
                    <label for="step3OldPrice">Pre√ßo Antigo (De:)</label>
                    <input type="text" id="step3OldPrice" placeholder="R$ 0,00" oninput="formatCurrencyInput(this)">
                    <small style="color: #888;">Deixe em branco ou digite 0 para ocultar.</small>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="step3PromoPrice" style="color: var(--shopee-red);">Pre√ßo Promocional (Por:)</label>
                    <input type="text" id="step3PromoPrice" placeholder="R$ 0,00" style="border-color: var(--shopee-red); font-weight: bold;" oninput="formatCurrencyInput(this)">
                    <small style="color: #888;">Deixe em branco ou digite 0 para ocultar.</small>
                </div>
            </div>
        </div>

        <div class="step-content" data-step="4">
            <h2>Etapa 4: Ajustes Finais e Download</h2>
            
            <div class="final-step-container">
                 <div class="preview-wrapper">
                    <div class="canvas-column">
                        <div style="font-weight: bold; margin-bottom: 10px; text-align: center;">Feed</div>
                        <div id="feed-design" class="design-canvas">
                            <div class="content-area">
                                <div class="image-wrapper movable"><img id="viewImgFeed" class="img-display" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></div>
                                <div id="viewDescFeed" class="text-desc movable">AGUARDANDO...</div>
                                <div class="price-container">
                                    <div id="viewOldFeed" class="price-old movable">R$ 0,00</div>
                                    <div id="viewPromoFeed" class="promo-button movable">VALOR</div>
                                </div>
                            </div>
                        </div>
                        <button class="download-btn" onclick="download('feed-design', 'post-feed')">BAIXAR FEED</button>
                    </div>
                    <div class="control-panel">
                        <div class="panel-header">Ajustes Feed</div>
                         <div class="unified-group"><span class="control-label">Imagem (Posi√ß√£o/Zoom)</span><div class="move-actions"><button class="btn-move" onclick="adjustPos('feed', 'img', 'top', -2)">‚¨ÜÔ∏è</button><button class="btn-move" onclick="adjustPos('feed', 'img', 'top', 2)">‚¨áÔ∏è</button><button class="btn-move" onclick="adjustPos('feed', 'img', 'left', -2)">‚¨ÖÔ∏è</button><button class="btn-move" onclick="adjustPos('feed', 'img', 'left', 2)">‚û°Ô∏è</button></div><div class="size-actions" style="margin-top:5px"><button class="btn-size" onclick="adjustScale('feed', -0.1)">-</button><span id="disp-f-img-scale" class="size-display">100%</span><button class="btn-size" onclick="adjustScale('feed', 0.1)">+</button></div></div>
                        <div class="unified-group"><span class="control-label">Descri√ß√£o (Fonte/Pos)</span><div class="size-actions"><button class="btn-size" onclick="adjustValue('feed', 'desc', -1)">-</button><span id="disp-f-desc-size" class="size-display">12</span><button class="btn-size" onclick="adjustValue('feed', 'desc', 1)">+</button></div><div class="move-actions"><button class="btn-move" onclick="adjustPos('feed', 'desc', 'top', -2)">‚¨ÜÔ∏è</button><button class="btn-move" onclick="adjustPos('feed', 'desc', 'top', 2)">‚¨áÔ∏è</button><button class="btn-move" onclick="adjustPos('feed', 'desc', 'left', -2)">‚¨ÖÔ∏è</button><button class="btn-move" onclick="adjustPos('feed', 'desc', 'left', 2)">‚û°Ô∏è</button></div></div>
                        <div class="unified-group"><span class="control-label special-label">Bot√£o (Box/Pos)</span><div class="size-actions"><button class="btn-size" onclick="adjustValue('feed', 'btn', -1)">-</button><span id="disp-f-btn-size" class="size-display">18</span><button class="btn-size" onclick="adjustValue('feed', 'btn', 1)">+</button></div><div class="move-actions"><button class="btn-move" onclick="adjustPos('feed', 'btn', 'top', -2)">‚¨ÜÔ∏è</button><button class="btn-move" onclick="adjustPos('feed', 'btn', 'top', 2)">‚¨áÔ∏è</button><button class="btn-move" onclick="adjustPos('feed', 'btn', 'left', -2)">‚¨ÖÔ∏è</button><button class="btn-move" onclick="adjustPos('feed', 'btn', 'left', 2)">‚û°Ô∏è</button></div></div>
                    </div>
                </div>

                <div class="preview-wrapper">
                    <div class="canvas-column">
                        <div style="font-weight: bold; margin-bottom: 10px; text-align: center;">Story</div>
                        <div id="story-design" class="design-canvas">
                            <div class="content-area">
                                <div class="image-wrapper movable"><img id="viewImgStory" class="img-display" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></div>
                                <div id="viewDescStory" class="text-desc movable">AGUARDANDO...</div>
                                <div class="price-container">
                                    <div id="viewOldStory" class="price-old movable">R$ 0,00</div>
                                    <div id="viewPromoStory" class="promo-button movable">VALOR</div>
                                </div>
                            </div>
                        </div>
                        <button class="download-btn btn-story" onclick="download('story-design', 'post-story')">BAIXAR STORY</button>
                    </div>
                    <div class="control-panel" style="border-color: #8e44ad;">
                        <div class="panel-header" style="background: #f4eafc; color: #8e44ad;">Ajustes Story</div>
                        <div class="unified-group"><span class="control-label">Imagem (Posi√ß√£o/Zoom)</span><div class="move-actions"><button class="btn-move" onclick="adjustPos('story', 'img', 'top', -2)">‚¨ÜÔ∏è</button><button class="btn-move" onclick="adjustPos('story', 'img', 'top', 2)">‚¨áÔ∏è</button><button class="btn-move" onclick="adjustPos('story', 'img', 'left', -2)">‚¨ÖÔ∏è</button><button class="btn-move" onclick="adjustPos('story', 'img', 'left', 2)">‚û°Ô∏è</button></div><div class="size-actions" style="margin-top:5px"><button class="btn-size" onclick="adjustScale('story', -0.1)">-</button><span id="disp-s-img-scale" class="size-display">100%</span><button class="btn-size" onclick="adjustScale('story', 0.1)">+</button></div></div>
                        <div class="unified-group"><span class="control-label">Descri√ß√£o (Fonte/Pos)</span><div class="size-actions"><button class="btn-size" onclick="adjustValue('story', 'desc', -1)">-</button><span id="disp-s-desc-size" class="size-display">14</span><button class="btn-size" onclick="adjustValue('story', 'desc', 1)">+</button></div><div class="move-actions"><button class="btn-move" onclick="adjustPos('story', 'desc', 'top', -2)">‚¨ÜÔ∏è</button><button class="btn-move" onclick="adjustPos('story', 'desc', 'top', 2)">‚¨áÔ∏è</button><button class="btn-move" onclick="adjustPos('story', 'desc', 'left', -2)">‚¨ÖÔ∏è</button><button class="btn-move" onclick="adjustPos('story', 'desc', 'left', 2)">‚û°Ô∏è</button></div></div>
                        <div class="unified-group"><span class="control-label">Pre√ßo Antigo</span><div class="size-actions"><button class="btn-size" onclick="adjustValue('story', 'old', -1)">-</button><span id="disp-s-old-size" class="size-display">15</span><button class="btn-size" onclick="adjustValue('story', 'old', 1)">+</button></div><div class="move-actions"><button class="btn-move" onclick="adjustPos('story', 'old', 'top', -2)">‚¨ÜÔ∏è</button><button class="btn-move" onclick="adjustPos('story', 'old', 'top', 2)">‚¨áÔ∏è</button><button class="btn-move" onclick="adjustPos('story', 'old', 'left', -2)">‚¨ÖÔ∏è</button><button class="btn-move" onclick="adjustPos('story', 'old', 'left', 2)">‚û°Ô∏è</button></div></div>
                        <div class="unified-group"><span class="control-label special-label">Bot√£o (Box/Pos)</span><div class="size-actions"><button class="btn-size" onclick="adjustValue('story', 'btn', -1)">-</button><span id="disp-s-btn-size" class="size-display">20</span><button class="btn-size" onclick="adjustValue('story', 'btn', 1)">+</button></div><div class="move-actions"><button class="btn-move" onclick="adjustPos('story', 'btn', 'top', -2)">‚¨ÜÔ∏è</button><button class="btn-move" onclick="adjustPos('story', 'btn', 'top', 2)">‚¨áÔ∏è</button><button class="btn-move" onclick="adjustPos('story', 'btn', 'left', -2)">‚¨ÖÔ∏è</button><button class="btn-move" onclick="adjustPos('story', 'btn', 'left', 2)">‚û°Ô∏è</button></div></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="nav-buttons">
            <button class="btn-nav btn-prev" id="btnPrev" onclick="changeStep(-1)" disabled>Voltar</button>
            <button class="btn-nav btn-next" id="btnNext" onclick="changeStep(1)">Continuar</button>
        </div>
    </div>

<script>
    // ==================================================================
    // CONFIGURA√á√ÉO DO N8N - COLE SUA URL ABAIXO
    // ==================================================================
    const N8N_WEBHOOK_URL = "http://host.docker.internal:5678/webhook-test/shopee-data"; 
    // Exemplo: "https://seu-n8n.com/webhook/shopee-data"
    // ==================================================================


    // ESTADO GLOBAL (Mantido da v23 para os controles funcionarem)
    let appState = { feed: { imgTop: 0, imgLeft: 0, imgScale: 1.0, descTop: 0, descLeft: 0, descSize: 12, oldTop: 0, oldLeft: 0, oldSize: 13, btnTop: 0, btnLeft: 0, btnSize: 18 }, story: { imgTop: 0, imgLeft: 0, imgScale: 1.0, descTop: -20, descLeft: 0, descSize: 14, oldTop: 0, oldLeft: 0, oldSize: 15, btnTop: 0, btnLeft: 0, btnSize: 20 } };
    let currentStep = 1; const totalSteps = 4;

    // --- L√ìGICA DO WIZARD ---
    function changeStep(direction) {
        const newStep = currentStep + direction; if (newStep < 1 || newStep > totalSteps) return;
        if (direction === 1 && currentStep === 2 && !document.getElementById('step2Title').value.trim()) { alert("Por favor, informe um t√≠tulo para o produto."); return; }
        currentStep = newStep; updateWizardUI(); if (currentStep === 4) { updateFinalPreviews(); }
    }
    function updateWizardUI() {
        document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active-step')); document.querySelector(`.step-content[data-step="${currentStep}"]`).classList.add('active-step');
        for (let i = 1; i <= totalSteps; i++) { const indicator = document.getElementById(`indicator${i}`); indicator.classList.remove('active', 'completed'); if (i < currentStep) indicator.classList.add('completed'); if (i === currentStep) indicator.classList.add('active'); }
        document.getElementById('btnPrev').disabled = currentStep === 1; document.getElementById('btnNext').textContent = currentStep === totalSteps ? "Concluir" : "Continuar"; if(currentStep === totalSteps) document.getElementById('btnNext').style.display = 'none'; else document.getElementById('btnNext').style.display = 'block';
    }

    // --- FUN√á√ïES DE UPLOAD ---
    function handleFileSelect(event, type, statusId) { const file = event.target.files[0]; if (file) { const bgUrl = URL.createObjectURL(file); document.getElementById(type === 'feed' ? 'feed-design' : 'story-design').style.backgroundImage = `url(${bgUrl})`; document.getElementById('thumb-' + type).src = bgUrl; document.getElementById('thumb-' + type).style.display = 'block'; document.getElementById('icon-' + type).style.display = 'none'; document.getElementById(statusId).style.display = 'block'; } }
    function handleProductImg(event) { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = function(e) { updateProductImageDisplays(e.target.result); }; reader.readAsDataURL(file); } }
    // Fun√ß√£o auxiliar para atualizar todas as views da imagem do produto
    function updateProductImageDisplays(imageUrl) {
        document.getElementById('viewImgFeed').src = imageUrl; document.getElementById('viewImgStory').src = imageUrl;
        document.getElementById('thumb-prod').src = imageUrl; document.getElementById('thumb-prod').style.display = 'block'; document.getElementById('icon-prod').style.display = 'none';
        document.getElementById('status-prod').style.display = 'block';
    }


    // --- NOVA FUN√á√ÉO: CHAMADA API N8N (ETAPA 2) ---
    async function fetchDataFromN8N() {
        const url = document.getElementById('step2Link').value.trim();
        const statusMsg = document.getElementById('api-status-message');
        const btnApi = document.getElementById('btn-api-call');

        if (!url) { alert("Cole um link primeiro."); return; }
        if (N8N_WEBHOOK_URL.includes("COLE_SUA_URL")) { alert("Configure a URL do seu n8n no c√≥digo HTML antes de usar."); return; }

        // Estado de carregamento
        statusMsg.innerText = "‚è≥ Consultando API via n8n..."; statusMsg.style.color = "#666";
        btnApi.disabled = true; btnApi.style.opacity = "0.7";

        try {
            const response = await fetch(N8N_WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ link: url }) // Envia o link para o n8n
            });

            if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
            const data = await response.json();

            if (data.success) {
                // Sucesso! Preenche os campos
                statusMsg.innerText = "‚úÖ Dados recebidos com sucesso!"; statusMsg.style.color = "var(--success-green)";
                
                if(data.data.title) document.getElementById('step2Title').value = data.data.title.toUpperCase();
                if(data.data.priceOld) document.getElementById('step3OldPrice').value = data.data.priceOld;
                if(data.data.pricePromo) document.getElementById('step3PromoPrice').value = data.data.pricePromo;
                
                // Se vier imagem da API, carrega ela!
                if(data.data.imageUrl && data.data.imageUrl.startsWith('http')) {
                    updateProductImageDisplays(data.data.imageUrl);
                    // Volta para a etapa 1 visualmente para mostrar que a imagem carregou
                    statusMsg.innerText += " (Imagem carregada na Etapa 1)";
                }

            } else {
                throw new Error(data.error || "O n8n retornou um erro.");
            }

        } catch (error) {
            console.error(error);
            statusMsg.innerText = "‚ùå Erro: " + error.message; statusMsg.style.color = "var(--shopee-red)";
        } finally {
            btnApi.disabled = false; btnApi.style.opacity = "1";
        }
    }

    // --- FUN√á√ïES AUXILIARES (Pre√ßo, Ocultar) ---
    function formatCurrencyInput(input) { let value = input.value.replace(/\D/g, ''); value = (parseInt(value) / 100).toFixed(2) + ''; value = value.replace(".", ","); value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1."); input.value = "R$ " + value; }
    function shouldHidePrice(valueStr) { if (!valueStr) return true; const trimmed = valueStr.trim(); if (trimmed === "" || trimmed === "R$ 0,00" || trimmed === "0") return true; return false; }
    function updateFinalPreviews() {
        const title = document.getElementById('step2Title').value || "T√çTULO DO PRODUTO";
        const oldInputVal = document.getElementById('step3OldPrice').value; const promoInputVal = document.getElementById('step3PromoPrice').value;
        document.getElementById('viewDescFeed').innerText = title; document.getElementById('viewDescStory').innerText = title;
        const hideOld = shouldHidePrice(oldInputVal); const oldDisplay = hideOld ? 'none' : 'block';
        const viewOldFeed = document.getElementById('viewOldFeed'); const viewOldStory = document.getElementById('viewOldStory'); viewOldFeed.innerText = oldInputVal || ""; viewOldFeed.style.display = oldDisplay; viewOldStory.innerText = oldInputVal || ""; viewOldStory.style.display = oldDisplay;
        const hidePromo = shouldHidePrice(promoInputVal); const promoDisplay = hidePromo ? 'none' : 'inline-flex';
        const viewPromoFeed = document.getElementById('viewPromoFeed'); const viewPromoStory = document.getElementById('viewPromoStory'); viewPromoFeed.innerText = promoInputVal || "VALOR"; viewPromoFeed.style.display = promoDisplay; viewPromoStory.innerText = promoInputVal || "VALOR"; viewPromoStory.style.display = promoDisplay;
    }

    // --- FUN√á√ïES DE CONTROLE (ESTADO GLOBAL v22) ---
    function adjustPos(t,e,a,o){const n=e+(a==="top"?"Top":"Left"),d=t+"-design",s="--"+t.charAt(0)+"-"+e+"-"+a;appState[t][n]+=o,document.getElementById(d).style.setProperty(s,appState[t][n]+"px")}function adjustValue(t,e,a){const o=e+"Size",n=t+"-design",d="--"+t.charAt(0)+"-"+e+"-size",s="disp-"+t.charAt(0)+"-"+e+"-size";let r=appState[t][o]+a;r<8&&(r=8),r>400&&(r=400),appState[t][o]=r,document.getElementById(n).style.setProperty(d,r+"px"),document.getElementById(s).innerText=r}function adjustScale(t,e){const a="imgScale",o=t+"-design",n="--"+t.charAt(0)+"-img-scale",d="disp-"+t.charAt(0)+"-img-scale";let s=appState[t][a]+e;s<.5&&(s=.5),s>3&&(s=3),appState[t][a]=s,document.getElementById(o).style.setProperty(n,s.toFixed(1)),document.getElementById(d).innerText=Math.round(100*s)+"%"}async function download(t,e){const a=document.getElementById(t);if(a.style.backgroundImage==="")return alert("Selecione um fundo na Etapa 1."),void 0;const o=await html2canvas(a,{scale:3,useCORS:!0}),n=document.createElement("a");n.download=`${e}.png`,n.href=o.toDataURL("image/png"),n.click()}

    updateWizardUI();
</script>
</body>
</html>
