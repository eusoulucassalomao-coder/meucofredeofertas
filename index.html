<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cofre de Ofertas v23 (Ocultar Pre√ßos Zerados)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* --- ESTILOS CSS ID√äNTICOS √Ä VERS√ÉO v22 --- */
        :root { --shopee-red: #ff2d2d; --bg-color: #f0f0f0; --success-green: #2e7d32; --panel-border: #e0e0e0; --step-active: #007bff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .main-container { width: 100%; max-width: 1100px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); margin-bottom: 30px; box-sizing: border-box; }
        .step-indicator-container { display: flex; justify-content: space-between; margin-bottom: 30px; position: relative; }
        .step-indicator-container::before { content: ''; position: absolute; top: 15px; left: 0; width: 100%; height: 3px; background: #eee; z-index: 0; }
        .step-indicator { position: relative; z-index: 1; background: #eee; color: #999; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: 0.3s; }
        .step-indicator.active { background: var(--shopee-red); color: white; box-shadow: 0 0 0 4px rgba(255, 45, 45, 0.2); }
        .step-indicator.completed { background: var(--success-green); color: white; }
        .step-content { display: none; animation: fadeIn 0.4s ease-in-out; }
        .step-content.active-step { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        h2 { color: #333; margin-top: 0; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 25px; }
        .form-group { margin-bottom: 20px; }
        label { font-weight: bold; font-size: 0.9rem; color: #555; display: block; margin-bottom: 8px; }
        input[type="text"], textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; transition: 0.3s; }
        input:focus, textarea:focus { border-color: var(--shopee-red); outline: none; }
        .upload-container-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .styled-upload-box { border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 12px; cursor: pointer; background: #fafafa; transition: 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 140px; }
        .styled-upload-box:hover { background: #f0f0f0; border-color: var(--shopee-red); }
        .upload-icon { font-size: 2rem; color: #999; margin-bottom: 10px; }
        .upload-thumbnail { width: 90px; height: 90px; object-fit: cover; border-radius: 8px; margin-bottom: 10px; border: 2px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: none; }
        .file-status { font-size: 0.8rem; color: var(--success-green); margin-top: 5px; font-weight: bold; display: none; }
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 40px; border-top: 1px solid #eee; padding-top: 20px; }
        .btn-nav { padding: 12px 25px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .btn-prev { background: #e0e0e0; color: #555; }
        .btn-prev:hover { background: #d0d0d0; }
        .btn-next { background: var(--shopee-red); color: white; margin-left: auto; }
        .btn-next:hover { background: #e60000; }
        .btn-disabled { opacity: 0.5; cursor: not-allowed; }
        .link-extraction-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-extract { background: #333; color: white; border: none; border-radius: 8px; padding: 0 20px; font-weight: bold; cursor: pointer; white-space: nowrap; }
        .btn-extract:hover { background: #555; }
        .link-helper { font-size: 0.8rem; color: #888; margin-top: 5px; background: #fff3cd; padding: 10px; border-radius: 5px; border-left: 4px solid #ffc107; }
        .final-step-container { display: flex; flex-wrap: wrap; gap: 30px; justify-content: center; }
        .preview-wrapper { display: flex; gap: 15px; align-items: flex-start; }
        @media (max-width: 800px) { .preview-wrapper { flex-wrap: wrap; justify-content: center; } }
        .canvas-column { display: flex; flex-direction: column; align-items: center; }
        .control-panel { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; flex-direction: column; min-width: 165px; overflow: hidden; border: 1px solid var(--panel-border); }
        .panel-header { background: #f9f9f9; padding: 10px; text-align: center; font-weight: 800; color: #555; font-size: 0.85rem; border-bottom: 1px solid var(--panel-border); text-transform: uppercase; }
        .unified-group { padding: 12px 10px; border-bottom: 1px solid #eee; display: flex; flex-direction: column; gap: 6px; }
        .unified-group:last-child { border-bottom: none; }
        .control-label { font-size: 0.7rem; font-weight: 800; color: #333; margin-bottom: 2px; display: block; text-transform: uppercase;}
        .special-label { color: var(--shopee-red); }
        .size-actions, .move-actions { display: flex; align-items: center; justify-content: space-between; background: #f0f0f0; border-radius: 6px; padding: 3px;}
        .move-actions { justify-content: center; gap: 3px; }
        .btn-size, .btn-move { width: 26px; height: 26px; border: 1px solid #ddd; background: white; color: #333; font-weight: bold; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-size:hover, .btn-move:hover { background: #eee; }
        .size-display { font-size: 0.8rem; font-weight: bold; color: #555; }
        .design-canvas { background-color: #ddd; background-size: 100% 100%; background-repeat: no-repeat; position: relative; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .content-area { position: absolute; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; box-sizing: border-box; }
        .image-wrapper { width: 100%; display: flex; align-items: center; justify-content: center; margin-bottom: 5px; overflow: hidden; }
        .img-display { max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; transition: transform 0.2s ease; }
        .text-desc { text-align: center; font-weight: 700; color: #333; text-transform: uppercase; line-height: 1.3; display: flex; align-items: center; justify-content: center; padding: 0 20px; box-sizing: border-box; width: 100%; }
        .price-container { display: flex; flex-direction: column; align-items: center; margin-top: auto; }
        .price-old { color: var(--shopee-red); text-decoration: line-through; font-weight: bold; margin-bottom: 2px; }
        .promo-button { background: var(--shopee-red); color: white; display: inline-flex; align-items: center; justify-content: center; border-radius: 10px; font-weight: 900; text-transform: uppercase; box-shadow: 0 2px 5px rgba(0,0,0,0.2); white-space: nowrap; padding: 0.4em 1em; }
        
        /* FEED SPECIFIC - Vari√°veis iniciais */
        #feed-design { width: 360px; height: 450px; --f-desc-size: 12px; --f-old-size: 13px; --f-btn-size: 18px; --f-img-scale: 1; --f-img-top: 0px; --f-img-left: 0px; --f-desc-top: 0px; --f-desc-left: 0px; --f-old-top: 0px; --f-old-left: 0px; --f-btn-top: 0px; --f-btn-left: 0px; }
        #feed-design .content-area { top: 125px; width: 290px; height: 290px; }
        #feed-design .image-wrapper { height: 170px; top: var(--f-img-top); left: var(--f-img-left); }
        #feed-design .img-display { transform: scale(var(--f-img-scale)); }
        #feed-design .text-desc { font-size: var(--f-desc-size); height: 45px; top: var(--f-desc-top); left: var(--f-desc-left); }
        #feed-design .price-container { padding-bottom: 10px; }
        #feed-design .price-old { font-size: var(--f-old-size); top: var(--f-old-top); left: var(--f-old-left); }
        #feed-design .promo-button { font-size: var(--f-btn-size); top: var(--f-btn-top); left: var(--f-btn-left); }

        /* STORY SPECIFIC - Vari√°veis iniciais */
        #story-design { width: 324px; height: 576px; --s-desc-size: 14px; --s-old-size: 15px; --s-btn-size: 20px; --s-img-scale: 1; --s-img-top: 0px; --s-img-left: 0px; --s-desc-top: -20px; --s-desc-left: 0px; --s-old-top: 0px; --s-old-left: 0px; --s-btn-top: 0px; --s-btn-left: 0px; }
        #story-design .content-area { top: 155px; width: 280px; height: 360px; }
        #story-design .image-wrapper { height: 185px; margin-bottom: 10px; top: var(--s-img-top); left: var(--s-img-left); }
        #story-design .img-display { transform: scale(var(--s-img-scale)); }
        #story-design .text-desc { font-size: var(--s-desc-size); height: 60px; margin-bottom: 5px; top: var(--s-desc-top); left: var(--s-desc-left); }
        #story-design .price-container { padding-bottom: 5px; }
        #story-design .price-old { font-size: var(--s-old-size); top: var(--s-old-top); left: var(--s-old-left); }
        #story-design .promo-button { font-size: var(--s-btn-size); top: var(--s-btn-top); left: var(--s-btn-left); }
        
        .download-btn { width: 100%; padding: 12px; background: #27ae60; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        .download-btn:hover { background: #219653; }
        .btn-story { background: #8e44ad; }
        .btn-story:hover { background: #732d91; }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="step-indicator-container">
            <div class="step-indicator active" id="indicator1">1</div>
            <div class="step-indicator" id="indicator2">2</div>
            <div class="step-indicator" id="indicator3">3</div>
            <div class="step-indicator" id="indicator4">4</div>
        </div>

        <div class="step-content active-step" data-step="1">
            <h2>Etapa 1: Imagens do Produto e Fundos</h2>
            <div class="upload-container-grid">
                <div class="styled-upload-box" onclick="document.getElementById('file-feed').click()">
                    <img id="thumb-feed" class="upload-thumbnail" src=""> <i id="icon-feed" class="upload-icon">üñºÔ∏è</i>
                    <label style="cursor: pointer;">Fundo do Feed (4:5)</label>
                    <input id="file-feed" type="file" hidden accept="image/*" onchange="handleFileSelect(event, 'feed', 'status-feed')">
                    <span id="status-feed" class="file-status">Imagem selecionada!</span>
                </div>
                <div class="styled-upload-box" onclick="document.getElementById('file-story').click()">
                    <img id="thumb-story" class="upload-thumbnail" src=""> <i id="icon-story" class="upload-icon">üì±</i>
                    <label style="cursor: pointer;">Fundo do Story (9:16)</label>
                    <input id="file-story" type="file" hidden accept="image/*" onchange="handleFileSelect(event, 'story', 'status-story')">
                    <span id="status-story" class="file-status">Imagem selecionada!</span>
                </div>
                 <div class="styled-upload-box" onclick="document.getElementById('inputImg').click()" style="border-color: var(--shopee-red); background: #fff5f5;">
                    <img id="thumb-prod" class="upload-thumbnail" src=""> <i id="icon-prod" class="upload-icon" style="color: var(--shopee-red);">üì∏</i>
                    <label style="cursor: pointer; color: var(--shopee-red);">Imagem do Produto (PNG)</label>
                    <input type="file" id="inputImg" hidden accept="image/*" onchange="handleProductImg(event)">
                    <span id="status-prod" class="file-status" style="color: var(--shopee-red);">Imagem selecionada!</span>
                </div>
            </div>
        </div>

        <div class="step-content" data-step="2">
            <h2>Etapa 2: T√≠tulo do Produto</h2>
            <div class="form-group">
                <label for="step2Link">Link do Produto (Shopee, Magalu, ML, Amazon)</label>
                <div class="link-extraction-group">
                    <input type="text" id="step2Link" placeholder="Cole o link aqui (Ex: https://www.magazinevoce.com.br/...)">
                    <button class="btn-extract" onclick="attemptTitleExtraction()">Tentar Extrair</button>
                </div>
                <p class="link-helper">‚ö†Ô∏è Links curtos (amzn.to, s.shopee, mercadolivre.com/sec) N√ÉO cont√™m o nome do produto. Para estes, digite o t√≠tulo manualmente abaixo.</p>
            </div>
            <div class="form-group">
                <label for="step2Title">T√≠tulo/Descri√ß√£o do Produto (Verifique ou Digite)</label>
                <textarea id="step2Title" rows="4" placeholder="O t√≠tulo aparecer√° aqui ou digite manualmente..."></textarea>
            </div>
        </div>

        <div class="step-content" data-step="3">
            <h2>Etapa 3: Valores da Oferta</h2>
            <div style="display: flex; gap: 20px;">
                <div class="form-group" style="flex: 1;">
                    <label for="step3OldPrice">Pre√ßo Antigo (De:)</label>
                    <input type="text" id="step3OldPrice" placeholder="R$ 0,00" oninput="formatCurrencyInput(this)">
                    <small style="color: #888;">Deixe em branco ou digite 0 para ocultar.</small>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="step3PromoPrice" style="color: var(--shopee-red);">Pre√ßo Promocional (Por:)</label>
                    <input type="text" id="step3PromoPrice" placeholder="R$ 0,00" style="border-color: var(--shopee-red); font-weight: bold;" oninput="formatCurrencyInput(this)">
                    <small style="color: #888;">Deixe em branco ou digite 0 para ocultar.</small>
                </div>
            </div>
        </div>

        <div class="step-content" data-step="4">
            <h2>Etapa 4: Ajustes Finais e Download</h2>
            
            <div class="final-step-container">
                 <div class="preview-wrapper">
                    <div class="canvas-column">
                        <div style="font-weight: bold; margin-bottom: 10px; text-align: center;">Feed</div>
                        <div id="feed-design" class="design-canvas">
                            <div class="content-area">
                                <div class="image-wrapper movable"><img id="viewImgFeed" class="img-display" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></div>
                                <div id="viewDescFeed" class="text-desc movable">AGUARDANDO...</div>
                                <div class="price-container">
                                    <div id="viewOldFeed" class="price-old movable">R$ 0,00</div>
                                    <div id="viewPromoFeed" class="promo-button movable">VALOR</div>
                                </div>
                            </div>
                        </div>
                        <button class="download-btn" onclick="download('feed-design', 'post-feed')">BAIXAR FEED</button>
                    </div>
                    <div class="control-panel">
                        <div class="panel-header">Ajustes Feed</div>
                         <div class="unified-group"><span class="control-label">Imagem (Posi√ß√£o/Zoom)</span><div class="move-actions"><button class="btn-move" onclick="adjustPos('feed', 'img', 'top', -2)">‚¨ÜÔ∏è</button><button class="btn-move" onclick="adjustPos('feed', 'img', 'top', 2)">‚¨áÔ∏è</button><button class="btn-move" onclick="adjustPos('feed', 'img', 'left', -2)">‚¨ÖÔ∏è</button><button class="btn-move" onclick="adjustPos('feed', 'img', 'left', 2)">‚û°Ô∏è</button></div><div class="size-actions" style="margin-top:5px"><button class="btn-size" onclick="adjustScale('feed', -0.1)">-</button><span id="disp-f-img-scale" class="size-display">100%</span><button class="btn-size" onclick="adjustScale('feed', 0.1)">+</button></div></div>
                        <div class="unified-group"><span class="control-label">Descri√ß√£o (Fonte/Pos)</span><div class="size-actions"><button class="btn-size" onclick="adjustValue('feed', 'desc', -1)">-</button><span id="disp-f-desc-size" class="size-display">12</span><button class="btn-size" onclick="adjustValue('feed', 'desc', 1)">+</button></div><div class="move-actions"><button class="btn-move" onclick="adjustPos('feed', 'desc', 'top', -2)">‚¨ÜÔ∏è</button><button class="btn-move" onclick="adjustPos('feed', 'desc', 'top', 2)">‚¨áÔ∏è</button><button class="btn-move" onclick="adjustPos('feed', 'desc', 'left', -2)">‚¨ÖÔ∏è</button><button class="btn-move" onclick="adjustPos('feed', 'desc', 'left', 2)">‚û°Ô∏è</button></div></div>
                        <div class="unified-group"><span class="control-label special-label">Bot√£o (Box/Pos)</span><div class="size-actions"><button class="btn-size" onclick="adjustValue('feed', 'btn', -1)">-</button><span id="disp-f-btn-size" class="size-display">18</span><button class="btn-size" onclick="adjustValue('feed', 'btn', 1)">+</button></div><div class="move-actions"><button class="btn-move" onclick="adjustPos('feed', 'btn', 'top', -2)">‚¨ÜÔ∏è</button><button class="btn-move" onclick="adjustPos('feed', 'btn', 'top', 2)">‚¨áÔ∏è</button><button class="btn-move" onclick="adjustPos('feed', 'btn', 'left', -2)">‚¨ÖÔ∏è</button><button class="btn-move" onclick="adjustPos('feed', 'btn', 'left', 2)">‚û°Ô∏è</button></div></div>
                    </div>
                </div>

                <div class="preview-wrapper">
                    <div class="canvas-column">
                        <div style="font-weight: bold; margin-bottom: 10px; text-align: center;">Story</div>
                        <div id="story-design" class="design-canvas">
                            <div class="content-area">
                                <div class="image-wrapper movable"><img id="viewImgStory" class="img-display" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></div>
                                <div id="viewDescStory" class="text-desc movable">AGUARDANDO...</div>
                                <div class="price-container">
                                    <div id="viewOldStory" class="price-old movable">R$ 0,00</div>
                                    <div id="viewPromoStory" class="promo-button movable">VALOR</div>
                                </div>
                            </div>
                        </div>
                        <button class="download-btn btn-story" onclick="download('story-design', 'post-story')">BAIXAR STORY</button>
                    </div>
                    <div class="control-panel" style="border-color: #8e44ad;">
                        <div class="panel-header" style="background: #f4eafc; color: #8e44ad;">Ajustes Story</div>
                        <div class="unified-group"><span class="control-label">Imagem (Posi√ß√£o/Zoom)</span><div class="move-actions"><button class="btn-move" onclick="adjustPos('story', 'img', 'top', -2)">‚¨ÜÔ∏è</button><button class="btn-move" onclick="adjustPos('story', 'img', 'top', 2)">‚¨áÔ∏è</button><button class="btn-move" onclick="adjustPos('story', 'img', 'left', -2)">‚¨ÖÔ∏è</button><button class="btn-move" onclick="adjustPos('story', 'img', 'left', 2)">‚û°Ô∏è</button></div><div class="size-actions" style="margin-top:5px"><button class="btn-size" onclick="adjustScale('story', -0.1)">-</button><span id="disp-s-img-scale" class="size-display">100%</span><button class="btn-size" onclick="adjustScale('story', 0.1)">+</button></div></div>
                        <div class="unified-group"><span class="control-label">Descri√ß√£o (Fonte/Pos)</span><div class="size-actions"><button class="btn-size" onclick="adjustValue('story', 'desc', -1)">-</button><span id="disp-s-desc-size" class="size-display">14</span><button class="btn-size" onclick="adjustValue('story', 'desc', 1)">+</button></div><div class="move-actions"><button class="btn-move" onclick="adjustPos('story', 'desc', 'top', -2)">‚¨ÜÔ∏è</button><button class="btn-move" onclick="adjustPos('story', 'desc', 'top', 2)">‚¨áÔ∏è</button><button class="btn-move" onclick="adjustPos('story', 'desc', 'left', -2)">‚¨ÖÔ∏è</button><button class="btn-move" onclick="adjustPos('story', 'desc', 'left', 2)">‚û°Ô∏è</button></div></div>
                        <div class="unified-group"><span class="control-label">Pre√ßo Antigo</span><div class="size-actions"><button class="btn-size" onclick="adjustValue('story', 'old', -1)">-</button><span id="disp-s-old-size" class="size-display">15</span><button class="btn-size" onclick="adjustValue('story', 'old', 1)">+</button></div><div class="move-actions"><button class="btn-move" onclick="adjustPos('story', 'old', 'top', -2)">‚¨ÜÔ∏è</button><button class="btn-move" onclick="adjustPos('story', 'old', 'top', 2)">‚¨áÔ∏è</button><button class="btn-move" onclick="adjustPos('story', 'old', 'left', -2)">‚¨ÖÔ∏è</button><button class="btn-move" onclick="adjustPos('story', 'old', 'left', 2)">‚û°Ô∏è</button></div></div>
                        <div class="unified-group"><span class="control-label special-label">Bot√£o (Box/Pos)</span><div class="size-actions"><button class="btn-size" onclick="adjustValue('story', 'btn', -1)">-</button><span id="disp-s-btn-size" class="size-display">20</span><button class="btn-size" onclick="adjustValue('story', 'btn', 1)">+</button></div><div class="move-actions"><button class="btn-move" onclick="adjustPos('story', 'btn', 'top', -2)">‚¨ÜÔ∏è</button><button class="btn-move" onclick="adjustPos('story', 'btn', 'top', 2)">‚¨áÔ∏è</button><button class="btn-move" onclick="adjustPos('story', 'btn', 'left', -2)">‚¨ÖÔ∏è</button><button class="btn-move" onclick="adjustPos('story', 'btn', 'left', 2)">‚û°Ô∏è</button></div></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="nav-buttons">
            <button class="btn-nav btn-prev" id="btnPrev" onclick="changeStep(-1)" disabled>Voltar</button>
            <button class="btn-nav btn-next" id="btnNext" onclick="changeStep(1)">Continuar</button>
        </div>
    </div>

<script>
    // --- ESTADO GLOBAL DA APLICA√á√ÉO (A Fonte da Verdade para os Controles) ---
    // Isso corrige definitivamente o problema dos bot√µes em elementos ocultos.
    let appState = {
        feed: {
            imgTop: 0, imgLeft: 0, imgScale: 1.0,
            descTop: 0, descLeft: 0, descSize: 12,
            oldTop: 0, oldLeft: 0, oldSize: 13,
            btnTop: 0, btnLeft: 0, btnSize: 18
        },
        story: {
            imgTop: 0, imgLeft: 0, imgScale: 1.0,
            descTop: -20, descLeft: 0, descSize: 14,
            oldTop: 0, oldLeft: 0, oldSize: 15,
            btnTop: 0, btnLeft: 0, btnSize: 20
        }
    };

    let currentStep = 1;
    const totalSteps = 4;

    // --- L√ìGICA DO WIZARD ---
    function changeStep(direction) {
        const newStep = currentStep + direction;
        if (newStep < 1 || newStep > totalSteps) return;
        if (direction === 1 && currentStep === 2 && !document.getElementById('step2Title').value.trim()) {
            alert("Por favor, informe um t√≠tulo para o produto."); return;
        }
        currentStep = newStep;
        updateWizardUI();
        if (currentStep === 4) { updateFinalPreviews(); }
    }

    function updateWizardUI() {
        document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active-step'));
        document.querySelector(`.step-content[data-step="${currentStep}"]`).classList.add('active-step');
        for (let i = 1; i <= totalSteps; i++) {
            const indicator = document.getElementById(`indicator${i}`);
            indicator.classList.remove('active', 'completed');
            if (i < currentStep) indicator.classList.add('completed');
            if (i === currentStep) indicator.classList.add('active');
        }
        document.getElementById('btnPrev').disabled = currentStep === 1;
        document.getElementById('btnNext').textContent = currentStep === totalSteps ? "Concluir" : "Continuar";
        if(currentStep === totalSteps) document.getElementById('btnNext').style.display = 'none'; else document.getElementById('btnNext').style.display = 'block';
    }

    // --- FUN√á√ïES DE UPLOAD E DADOS ---
    function handleFileSelect(event, type, statusId) {
        const file = event.target.files[0];
        if (file) {
            const bgUrl = URL.createObjectURL(file);
            document.getElementById(type === 'feed' ? 'feed-design' : 'story-design').style.backgroundImage = `url(${bgUrl})`;
            document.getElementById('thumb-' + type).src = bgUrl; document.getElementById('thumb-' + type).style.display = 'block'; document.getElementById('icon-' + type).style.display = 'none';
            document.getElementById(statusId).style.display = 'block';
        }
    }
    function handleProductImg(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('viewImgFeed').src = e.target.result; document.getElementById('viewImgStory').src = e.target.result;
                document.getElementById('thumb-prod').src = e.target.result; document.getElementById('thumb-prod').style.display = 'block'; document.getElementById('icon-prod').style.display = 'none';
                document.getElementById('status-prod').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    }
    function attemptTitleExtraction() {
        const url = document.getElementById('step2Link').value.trim(); const titleArea = document.getElementById('step2Title');
        if (!url) { alert("Cole um link primeiro."); return; }
        let extractedTitle = "";
        if (url.includes('magazinevoce') || url.includes('magazineluiza')) { try { const matches = url.match(/\.com\.br\/.*?\/(.*?)\/p\//i); if (matches && matches[1]) extractedTitle = decodeURIComponent(matches[1]).replace(/-/g, ' '); } catch(e){} } 
        else if (url.includes('shopee.com.br') && url.includes('-i.')) { try { const matches = url.match(/shopee\.com\.br\/(.*?)(?:-i\.|\?|$)/i); if (matches && matches[1]) extractedTitle = decodeURIComponent(matches[1]).replace(/-/g, ' '); } catch(e){} }
        if (url.match(/(s\.shopee|amzn\.to|mercadolivre\.com\/sec|bit\.ly)/i) && !extractedTitle) { alert("Links encurtados n√£o cont√™m o nome do produto na URL. Digite manualmente."); titleArea.value = ""; titleArea.focus(); return; }
        if (extractedTitle && extractedTitle.length > 3) { titleArea.value = extractedTitle.toUpperCase(); } else if (!extractedTitle) { alert("N√£o foi poss√≠vel extrair o t√≠tulo. Digite manualmente."); titleArea.focus(); }
    }
    function formatCurrencyInput(input) { let value = input.value.replace(/\D/g, ''); value = (parseInt(value) / 100).toFixed(2) + ''; value = value.replace(".", ","); value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1."); input.value = "R$ " + value; }

    // --- NOVA FUN√á√ÉO PARA OCULTAR PRE√áO ZERADO (v23) ---
    function shouldHidePrice(valueStr) {
        if (!valueStr) return true;
        const trimmed = valueStr.trim();
        if (trimmed === "" || trimmed === "R$ 0,00") return true;
        return false;
    }

    // --- FUN√á√ÉO DE ATUALIZA√á√ÉO FINAL (COM L√ìGICA DE OCULTAR) ---
    function updateFinalPreviews() {
        const title = document.getElementById('step2Title').value || "T√çTULO DO PRODUTO";
        const oldInputVal = document.getElementById('step3OldPrice').value;
        const promoInputVal = document.getElementById('step3PromoPrice').value;

        // Atualiza T√≠tulos
        document.getElementById('viewDescFeed').innerText = title;
        document.getElementById('viewDescStory').innerText = title;

        // Atualiza Pre√ßo Antigo (com l√≥gica de ocultar)
        const hideOld = shouldHidePrice(oldInputVal);
        const oldDisplay = hideOld ? 'none' : 'block';
        const viewOldFeed = document.getElementById('viewOldFeed'); const viewOldStory = document.getElementById('viewOldStory');
        viewOldFeed.innerText = oldInputVal || ""; viewOldFeed.style.display = oldDisplay;
        viewOldStory.innerText = oldInputVal || ""; viewOldStory.style.display = oldDisplay;

        // Atualiza Pre√ßo Promo (com l√≥gica de ocultar)
        const hidePromo = shouldHidePrice(promoInputVal);
        // Nota: o bot√£o promo usa 'inline-flex' no CSS original, ent√£o restauramos para isso
        const promoDisplay = hidePromo ? 'none' : 'inline-flex';
        const viewPromoFeed = document.getElementById('viewPromoFeed'); const viewPromoStory = document.getElementById('viewPromoStory');
        viewPromoFeed.innerText = promoInputVal || "VALOR"; viewPromoFeed.style.display = promoDisplay;
        viewPromoStory.innerText = promoInputVal || "VALOR"; viewPromoStory.style.display = promoDisplay;
    }


    // --- NOVAS FUN√á√ïES DE CONTROLE (BASEADAS NO ESTADO GLOBAL - INFAL√çVEIS) ---
    function adjustPos(type, target, axis, change) {
        // type: 'feed'/'story', target: 'img'/'desc'/'old'/'btn', axis: 'top'/'left'
        const stateKey = target + (axis === 'top' ? 'Top' : 'Left'); // ex: imgTop
        const containerId = type + '-design';
        const cssVar = '--' + type.charAt(0) + '-' + target + '-' + axis; // ex: --f-img-top

        // 1. Atualiza o estado
        appState[type][stateKey] += change;

        // 2. Aplica a mudan√ßa no DOM
        document.getElementById(containerId).style.setProperty(cssVar, appState[type][stateKey] + 'px');
    }

    function adjustValue(type, target, change) {
        // target: 'desc'/'old'/'btn'
        const stateKey = target + 'Size'; // ex: descSize
        const containerId = type + '-design';
        const cssVar = '--' + type.charAt(0) + '-' + target + '-size'; // ex: --f-desc-size
        const displayId = 'disp-' + type.charAt(0) + '-' + target + '-size'; // ex: disp-f-desc-size

        // 1. Atualiza o estado com limites
        let newSize = appState[type][stateKey] + change;
        if (newSize < 8) newSize = 8; if (newSize > 400) newSize = 400;
        appState[type][stateKey] = newSize;

        // 2. Aplica no DOM e atualiza o display num√©rico
        document.getElementById(containerId).style.setProperty(cssVar, newSize + 'px');
        document.getElementById(displayId).innerText = newSize;
    }

    function adjustScale(type, change) {
        const stateKey = 'imgScale';
        const containerId = type + '-design';
        const cssVar = '--' + type.charAt(0) + '-img-scale';
        const displayId = 'disp-' + type.charAt(0) + '-img-scale';

        // 1. Atualiza o estado com limites
        let newScale = appState[type][stateKey] + change;
        if (newScale < 0.5) newScale = 0.5; if (newScale > 3.0) newScale = 3.0;
        appState[type][stateKey] = newScale;

        // 2. Aplica no DOM
        document.getElementById(containerId).style.setProperty(cssVar, newScale.toFixed(1));
        document.getElementById(displayId).innerText = Math.round(newScale * 100) + '%';
    }

    async function download(id, name) { const area=document.getElementById(id); if(area.style.backgroundImage===''){alert("Selecione um fundo na Etapa 1.");return;} const canvas=await html2canvas(area,{scale:3,useCORS:true}); const link=document.createElement('a'); link.download=`${name}.png`; link.href=canvas.toDataURL('image/png'); link.click(); }

    updateWizardUI();
</script>
</body>
</html>
